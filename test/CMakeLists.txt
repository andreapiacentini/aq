list( APPEND aq_data_files
  ENS04_reduced/HMGEMS02+2010070406.nc
  ENS04_reduced/HMGEMS02+2010070406+E0001.nc
  ENS04_reduced/HMGEMS02+2010070406+E0002.nc
  ENS04_reduced/HMGEMS02+2010070406+E0003.nc
  ENS04_reduced/HMGEMS02+2010070406+E0004.nc
  ENS04_reduced/HMGEMS02+2010070406+E0005.nc
  ENS04_reduced/HMGEMS02+2010070406+E0006.nc
  ENS04_reduced/HMGEMS02+2010070406+E0007.nc
  ENS04_reduced/HMGEMS02+2010070406+E0008.nc
  ENS04_reduced/HMGEMS02+2010070406+E0009.nc
  ENS04_reduced/HMGEMS02+2010070406+E0010.nc
  HDAT+20100704.h5
  HGOM+20100704_CO.gom.nc
  HGOM+20100704_O3.gom.nc
)

list( APPEND aq_data_toplevel
  ENS04_reduced
  HDAT+20100704.h5
  HGOM+20100704_CO.gom.nc
  HGOM+20100704_O3.gom.nc
)

list( APPEND aq_data_files_tier2
  ENS04_reduced/HMGEMS02+2010070400+E0001.nc
  ENS04_reduced/HMGEMS02+2010070400+E0002.nc
  ENS04_reduced/HMGEMS02+2010070400+E0003.nc
  ENS04_reduced/HMGEMS02+2010070400+E0004.nc
  ENS04_reduced/HMGEMS02+2010070400+E0005.nc
  ENS04_reduced/HMGEMS02+2010070400+E0006.nc
  ENS04_reduced/HMGEMS02+2010070400+E0007.nc
  ENS04_reduced/HMGEMS02+2010070400+E0008.nc
  ENS04_reduced/HMGEMS02+2010070400+E0009.nc
  ENS04_reduced/HMGEMS02+2010070400+E0010.nc
  ENS04_reduced/HMGEMS02+2010070400+E0011.nc
  ENS04_reduced/HMGEMS02+2010070400+E0012.nc
  ENS04_reduced/HMGEMS02+2010070400+E0013.nc
  ENS04_reduced/HMGEMS02+2010070400+E0014.nc
  ENS04_reduced/HMGEMS02+2010070400+E0015.nc
  ENS04_reduced/HMGEMS02+2010070400+E0016.nc
  ENS04_reduced/HMGEMS02+2010070400+E0017.nc
  ENS04_reduced/HMGEMS02+2010070400+E0018.nc
  ENS04_reduced/HMGEMS02+2010070400+E0019.nc
  ENS04_reduced/HMGEMS02+2010070400+E0020.nc
  ENS04_reduced/HMGEMS02+2010070400+E0021.nc
  ENS04_reduced/HMGEMS02+2010070400+E0022.nc
  ENS04_reduced/HMGEMS02+2010070400+E0023.nc
  ENS04_reduced/HMGEMS02+2010070400+E0024.nc
  ENS04_reduced/HMGEMS02+2010070400+E0025.nc
  ENS04_reduced/HMGEMS02+2010070400.nc
  ENS04_reduced/HMGEMS02+2010070401+E0001.nc
  ENS04_reduced/HMGEMS02+2010070401+E0002.nc
  ENS04_reduced/HMGEMS02+2010070401+E0003.nc
  ENS04_reduced/HMGEMS02+2010070401+E0004.nc
  ENS04_reduced/HMGEMS02+2010070401+E0005.nc
  ENS04_reduced/HMGEMS02+2010070401+E0006.nc
  ENS04_reduced/HMGEMS02+2010070401+E0007.nc
  ENS04_reduced/HMGEMS02+2010070401+E0008.nc
  ENS04_reduced/HMGEMS02+2010070401+E0009.nc
  ENS04_reduced/HMGEMS02+2010070401+E0010.nc
  ENS04_reduced/HMGEMS02+2010070401+E0011.nc
  ENS04_reduced/HMGEMS02+2010070401+E0012.nc
  ENS04_reduced/HMGEMS02+2010070401+E0013.nc
  ENS04_reduced/HMGEMS02+2010070401+E0014.nc
  ENS04_reduced/HMGEMS02+2010070401+E0015.nc
  ENS04_reduced/HMGEMS02+2010070401+E0016.nc
  ENS04_reduced/HMGEMS02+2010070401+E0017.nc
  ENS04_reduced/HMGEMS02+2010070401+E0018.nc
  ENS04_reduced/HMGEMS02+2010070401+E0019.nc
  ENS04_reduced/HMGEMS02+2010070401+E0020.nc
  ENS04_reduced/HMGEMS02+2010070401+E0021.nc
  ENS04_reduced/HMGEMS02+2010070401+E0022.nc
  ENS04_reduced/HMGEMS02+2010070401+E0023.nc
  ENS04_reduced/HMGEMS02+2010070401+E0024.nc
  ENS04_reduced/HMGEMS02+2010070401+E0025.nc
  ENS04_reduced/HMGEMS02+2010070401.nc
  ENS04_reduced/HMGEMS02+2010070402+E0001.nc
  ENS04_reduced/HMGEMS02+2010070402+E0002.nc
  ENS04_reduced/HMGEMS02+2010070402+E0003.nc
  ENS04_reduced/HMGEMS02+2010070402+E0004.nc
  ENS04_reduced/HMGEMS02+2010070402+E0005.nc
  ENS04_reduced/HMGEMS02+2010070402+E0006.nc
  ENS04_reduced/HMGEMS02+2010070402+E0007.nc
  ENS04_reduced/HMGEMS02+2010070402+E0008.nc
  ENS04_reduced/HMGEMS02+2010070402+E0009.nc
  ENS04_reduced/HMGEMS02+2010070402+E0010.nc
  ENS04_reduced/HMGEMS02+2010070402+E0011.nc
  ENS04_reduced/HMGEMS02+2010070402+E0012.nc
  ENS04_reduced/HMGEMS02+2010070402+E0013.nc
  ENS04_reduced/HMGEMS02+2010070402+E0014.nc
  ENS04_reduced/HMGEMS02+2010070402+E0015.nc
  ENS04_reduced/HMGEMS02+2010070402+E0016.nc
  ENS04_reduced/HMGEMS02+2010070402+E0017.nc
  ENS04_reduced/HMGEMS02+2010070402+E0018.nc
  ENS04_reduced/HMGEMS02+2010070402+E0019.nc
  ENS04_reduced/HMGEMS02+2010070402+E0020.nc
  ENS04_reduced/HMGEMS02+2010070402+E0021.nc
  ENS04_reduced/HMGEMS02+2010070402+E0022.nc
  ENS04_reduced/HMGEMS02+2010070402+E0023.nc
  ENS04_reduced/HMGEMS02+2010070402+E0024.nc
  ENS04_reduced/HMGEMS02+2010070402+E0025.nc
  ENS04_reduced/HMGEMS02+2010070402.nc
  ENS04_reduced/HMGEMS02+2010070403+E0001.nc
  ENS04_reduced/HMGEMS02+2010070403+E0002.nc
  ENS04_reduced/HMGEMS02+2010070403+E0003.nc
  ENS04_reduced/HMGEMS02+2010070403+E0004.nc
  ENS04_reduced/HMGEMS02+2010070403+E0005.nc
  ENS04_reduced/HMGEMS02+2010070403+E0006.nc
  ENS04_reduced/HMGEMS02+2010070403+E0007.nc
  ENS04_reduced/HMGEMS02+2010070403+E0008.nc
  ENS04_reduced/HMGEMS02+2010070403+E0009.nc
  ENS04_reduced/HMGEMS02+2010070403+E0010.nc
  ENS04_reduced/HMGEMS02+2010070403+E0011.nc
  ENS04_reduced/HMGEMS02+2010070403+E0012.nc
  ENS04_reduced/HMGEMS02+2010070403+E0013.nc
  ENS04_reduced/HMGEMS02+2010070403+E0014.nc
  ENS04_reduced/HMGEMS02+2010070403+E0015.nc
  ENS04_reduced/HMGEMS02+2010070403+E0016.nc
  ENS04_reduced/HMGEMS02+2010070403+E0017.nc
  ENS04_reduced/HMGEMS02+2010070403+E0018.nc
  ENS04_reduced/HMGEMS02+2010070403+E0019.nc
  ENS04_reduced/HMGEMS02+2010070403+E0020.nc
  ENS04_reduced/HMGEMS02+2010070403+E0021.nc
  ENS04_reduced/HMGEMS02+2010070403+E0022.nc
  ENS04_reduced/HMGEMS02+2010070403+E0023.nc
  ENS04_reduced/HMGEMS02+2010070403+E0024.nc
  ENS04_reduced/HMGEMS02+2010070403+E0025.nc
  ENS04_reduced/HMGEMS02+2010070403.nc
  ENS04_reduced/HMGEMS02+2010070404+E0001.nc
  ENS04_reduced/HMGEMS02+2010070404+E0002.nc
  ENS04_reduced/HMGEMS02+2010070404+E0003.nc
  ENS04_reduced/HMGEMS02+2010070404+E0004.nc
  ENS04_reduced/HMGEMS02+2010070404+E0005.nc
  ENS04_reduced/HMGEMS02+2010070404+E0006.nc
  ENS04_reduced/HMGEMS02+2010070404+E0007.nc
  ENS04_reduced/HMGEMS02+2010070404+E0008.nc
  ENS04_reduced/HMGEMS02+2010070404+E0009.nc
  ENS04_reduced/HMGEMS02+2010070404+E0010.nc
  ENS04_reduced/HMGEMS02+2010070404+E0011.nc
  ENS04_reduced/HMGEMS02+2010070404+E0012.nc
  ENS04_reduced/HMGEMS02+2010070404+E0013.nc
  ENS04_reduced/HMGEMS02+2010070404+E0014.nc
  ENS04_reduced/HMGEMS02+2010070404+E0015.nc
  ENS04_reduced/HMGEMS02+2010070404+E0016.nc
  ENS04_reduced/HMGEMS02+2010070404+E0017.nc
  ENS04_reduced/HMGEMS02+2010070404+E0018.nc
  ENS04_reduced/HMGEMS02+2010070404+E0019.nc
  ENS04_reduced/HMGEMS02+2010070404+E0020.nc
  ENS04_reduced/HMGEMS02+2010070404+E0021.nc
  ENS04_reduced/HMGEMS02+2010070404+E0022.nc
  ENS04_reduced/HMGEMS02+2010070404+E0023.nc
  ENS04_reduced/HMGEMS02+2010070404+E0024.nc
  ENS04_reduced/HMGEMS02+2010070404+E0025.nc
  ENS04_reduced/HMGEMS02+2010070404.nc
  ENS04_reduced/HMGEMS02+2010070405+E0001.nc
  ENS04_reduced/HMGEMS02+2010070405+E0002.nc
  ENS04_reduced/HMGEMS02+2010070405+E0003.nc
  ENS04_reduced/HMGEMS02+2010070405+E0004.nc
  ENS04_reduced/HMGEMS02+2010070405+E0005.nc
  ENS04_reduced/HMGEMS02+2010070405+E0006.nc
  ENS04_reduced/HMGEMS02+2010070405+E0007.nc
  ENS04_reduced/HMGEMS02+2010070405+E0008.nc
  ENS04_reduced/HMGEMS02+2010070405+E0009.nc
  ENS04_reduced/HMGEMS02+2010070405+E0010.nc
  ENS04_reduced/HMGEMS02+2010070405+E0011.nc
  ENS04_reduced/HMGEMS02+2010070405+E0012.nc
  ENS04_reduced/HMGEMS02+2010070405+E0013.nc
  ENS04_reduced/HMGEMS02+2010070405+E0014.nc
  ENS04_reduced/HMGEMS02+2010070405+E0015.nc
  ENS04_reduced/HMGEMS02+2010070405+E0016.nc
  ENS04_reduced/HMGEMS02+2010070405+E0017.nc
  ENS04_reduced/HMGEMS02+2010070405+E0018.nc
  ENS04_reduced/HMGEMS02+2010070405+E0019.nc
  ENS04_reduced/HMGEMS02+2010070405+E0020.nc
  ENS04_reduced/HMGEMS02+2010070405+E0021.nc
  ENS04_reduced/HMGEMS02+2010070405+E0022.nc
  ENS04_reduced/HMGEMS02+2010070405+E0023.nc
  ENS04_reduced/HMGEMS02+2010070405+E0024.nc
  ENS04_reduced/HMGEMS02+2010070405+E0025.nc
  ENS04_reduced/HMGEMS02+2010070405.nc
  HDAT+20100704.h5
)

list( APPEND aq_data_toplevel_tier2
  ENS04_reduced
  HDAT+20100704.h5
)

list( APPEND aq_testinput
  testinput/3densvar.yaml
  testinput/addincrement.yaml
  testinput/addincrement_scaled.yaml
  testinput/diffstates.yaml
  testinput/dirac_loc_3d.yaml
  testinput/dirac_no_loc_3d.yaml
  testinput/ens_recenter.yaml
  testinput/ens_variance.yaml
  testinput/ens_variance_inflation_value.yaml
  testinput/getvalues.yaml
  testinput/hofx3d.yaml
  testinput/interfaces.yaml
  testinput/lineargetvalues.yaml
  testinput/parameters_loc_6pe.yaml
)

list( APPEND aq_testinput_tier2
  testinput/4densvar.yaml
  testinput/4densvar_transform.yaml
  testinput/dirac_loc_4d.yaml
  testinput/dirac_no_loc_4d.yaml
  testinput/parameters_loc_2pe.yaml
)

list( APPEND aq_testoutput
  testoutput/3densvar.test
  testoutput/addincrement.test
  testoutput/addincrement_scaled.test
  testoutput/diffstates.test
  testoutput/dirac_loc_3d.test
  testoutput/dirac_no_loc_3d.test
  testoutput/ens_recenter.test
  testoutput/ens_variance.test
  testoutput/ens_variance_inflation_value.test
  testoutput/hofx3d.test
  testoutput/parameters_loc_6pe.test
)

list( APPEND aq_testoutput_tier2
  testoutput/4densvar.test
  testoutput/4densvar_transform.test
  testoutput/dirac_loc_4d.test
  testoutput/dirac_no_loc_4d.test
  testoutput/parameters_loc_2pe.test
)


# Link scripts
list( APPEND tools_files
    aq_data_downloader.sh
    aq_data_linker.sh
)

# Set the test tiering
# --------------------
set( AQ_JEDI_TEST_TIER 1 )

# Override AQ_JEDI_TEST_TIER using environment variable
if( DEFINED ENV{AQ_JEDI_TEST_TIER} )
    set( AQ_JEDI_TEST_TIER "$ENV{AQ_JEDI_TEST_TIER}" )
endif()

message(STATUS "Running aq tests for tiers up to and including tier " ${AQ_JEDI_TEST_TIER})

foreach( FILENAME ${tools_files} )
    execute_process( COMMAND ${CMAKE_COMMAND} -E create_symlink
                             ${PROJECT_SOURCE_DIR}/test/${FILENAME}
                             ${CMAKE_BINARY_DIR}/bin/${FILENAME} )
endforeach()


# Create data directory
file(MAKE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/Data)

# Create data directory for test input and symlink all files
file(MAKE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/testinput)
foreach(FILENAME ${aq_testinput})
    execute_process( COMMAND ${CMAKE_COMMAND} -E create_symlink
           ${CMAKE_CURRENT_SOURCE_DIR}/${FILENAME}
           ${CMAKE_CURRENT_BINARY_DIR}/${FILENAME} )
endforeach(FILENAME)

# Create data directory for reference output and symlink all files
file(MAKE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/testoutput)
foreach(FILENAME ${aq_testoutput})
    execute_process( COMMAND ${CMAKE_COMMAND} -E create_symlink
           ${CMAKE_CURRENT_SOURCE_DIR}/${FILENAME}
           ${CMAKE_CURRENT_BINARY_DIR}/${FILENAME} )
endforeach(FILENAME)

ecbuild_add_resources( TARGET   aq_test_scripts
                       SOURCES_PACK
                       ${aq_testinput}
                     )

if (AQ_JEDI_TEST_TIER GREATER_EQUAL 2)
    foreach(FILENAME ${aq_testinput_tier2})
        execute_process( COMMAND ${CMAKE_COMMAND} -E create_symlink
               ${CMAKE_CURRENT_SOURCE_DIR}/${FILENAME}
               ${CMAKE_CURRENT_BINARY_DIR}/${FILENAME} )
    endforeach(FILENAME)

    foreach(FILENAME ${aq_testoutput_tier2})
        execute_process( COMMAND ${CMAKE_COMMAND} -E create_symlink
               ${CMAKE_CURRENT_SOURCE_DIR}/${FILENAME}
               ${CMAKE_CURRENT_BINARY_DIR}/${FILENAME} )
    endforeach(FILENAME)

    ecbuild_add_resources( TARGET   aq_test_scripts_tier2
                           SOURCES_PACK
                           ${aq_testinput_tier2}
                         )
endif()

#####################################################################
# download test
#####################################################################

if( DEFINED ENV{AQ_JEDI_LOCAL_PATH_TESTFILES} )
    ecbuild_add_test( TARGET    link_data_aq
                      TYPE      SCRIPT
                      COMMAND   ${CMAKE_BINARY_DIR}/bin/aq_data_linker.sh
                      ARGS  ${aq_data_toplevel} )
else()
    ecbuild_add_test( TARGET    get_data_aq
                      TYPE      SCRIPT
                      COMMAND   ${CMAKE_BINARY_DIR}/bin/aq_data_downloader.sh
                      ARGS  ${aq_data_files} )
endif()

if (AQ_JEDI_TEST_TIER GREATER_EQUAL 2)
    if( NOT DEFINED ENV{AQ_JEDI_LOCAL_PATH_TESTFILES} )
        ecbuild_add_test( TARGET    get_data_aq_tier2
                          TYPE      SCRIPT
                          COMMAND   ${CMAKE_BINARY_DIR}/bin/aq_data_downloader.sh
                          ARGS  ${aq_data_files_tier2} )
    endif()
endif()

#####################################################################
# interface tests
#####################################################################

ecbuild_add_test( TARGET  test_aq_geometry
                  MPI 6
                  OMP 4
                  SOURCES executables/TestGeometry.cc
                  ARGS    "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET  test_aq_geovals
                  MPI 6
                  OMP 4
                  SOURCES executables/TestGeoVaLs.cc
                  ARGS    "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET  test_aq_state
                  MPI 6
                  OMP 4
                  SOURCES executables/TestState.cc
                  ARGS    "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET  test_aq_increment
                  MPI 6
                  OMP 4
                  SOURCES executables/TestIncrement.cc
                  ARGS    "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET test_aq_locations
                  MPI 6
                  OMP 4
                  SOURCES executables/TestLocations.cc
                  ARGS "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET test_aq_obsspace
                  MPI 6
                  OMP 4
                  SOURCES executables/TestObsSpace.cc
                  ARGS "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET test_aq_obs_vector
                  MPI 6
                  OMP 4
                  SOURCES executables/TestObsVector.cc
                  ARGS "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET test_aq_obsdatavector
                  MPI 6
                  OMP 4
                  SOURCES executables/TestObsDataVector.cc
                  ARGS "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET  test_aq_obs_operator
                  MPI 6
                  OMP 4
                  SOURCES executables/TestObsOperator.cc
                  ARGS    "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET  test_aq_lin_obs_operator
                  MPI 6
                  OMP 4
                  SOURCES executables/TestLinearObsOperator.cc
                  ARGS    "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET test_aq_obs_error_covar
                  MPI 6
                  OMP 4
                  SOURCES executables/TestObsErrorCovariance.cc
                  ARGS "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET  test_aq_obs_aux
                  MPI 6
                  OMP 4
                  SOURCES executables/TestObsAuxControl.cc
                  ARGS    "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET  test_aq_obs_aux_increment
                  MPI 6
                  OMP 4
                  SOURCES executables/TestObsAuxIncrement.cc
                  ARGS    "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET  test_aq_obs_aux_covariance
                  MPI 6
                  OMP 4
                  SOURCES executables/TestObsAuxCovariance.cc
                  ARGS    "testinput/interfaces.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET  test_aq_getvalues
                  MPI 6
                  OMP 4
                  SOURCES executables/TestGetValues.cc
                  ARGS    "testinput/getvalues.yaml"
                  LIBS    aq )

ecbuild_add_test( TARGET  test_aq_lineargetvalues
                  MPI 6
                  OMP 4
                  SOURCES executables/TestLinearGetValues.cc
                  ARGS    "testinput/lineargetvalues.yaml"
                  LIBS    aq )

#####################################################################
# obs-related tests
#####################################################################

ecbuild_add_test( TARGET test_aq_hofx3d
                  MPI 6
                  OMP 4
                  ARGS testinput/hofx3d.yaml
                  COMMAND  aq_hofx3d.x )

#####################################################################
# ensemble-related tests
#####################################################################

ecbuild_add_test( TARGET test_aq_ens_variance
                  MPI 6
                  OMP 4
                  ARGS testinput/ens_variance.yaml
                  COMMAND  aq_ens_variance.x )

ecbuild_add_test( TARGET test_aq_ens_recenter
                  MPI 6
                  OMP 4
                  ARGS testinput/ens_recenter.yaml
                  COMMAND  aq_ens_recenter.x )

ecbuild_add_test( TARGET test_aq_ens_variance_inflation_value
                  MPI 6
                  OMP 4
                  ARGS testinput/ens_variance_inflation_value.yaml
                  COMMAND  aq_ens_variance.x )

#####################################################################
# B Matrix tests
#####################################################################

ecbuild_add_test( TARGET test_aq_parameters_loc_6pe
                  MPI 6
                  OMP 4
                  ARGS testinput/parameters_loc_6pe.yaml
                  COMMAND  aq_error_covariance_training.x )

#####################################################################
# dirac tests
#####################################################################

ecbuild_add_test( TARGET test_aq_dirac_no_loc_3d
                  MPI 6
                  OMP 4
                  ARGS testinput/dirac_no_loc_3d.yaml
                  COMMAND  aq_dirac.x )

ecbuild_add_test( TARGET test_aq_dirac_loc_3d
                  MPI 6
                  OMP 4
                  ARGS testinput/dirac_loc_3d.yaml
                  COMMAND  aq_dirac.x
                  TEST_DEPENDS test_aq_parameters_loc_6pe )

#####################################################################
# 3d variational tests
#####################################################################

ecbuild_add_test( TARGET test_aq_3densvar
                  MPI 6
                  OMP 4
                  ARGS testinput/3densvar.yaml
                  COMMAND  aq_var.x
                  TEST_DEPENDS test_aq_parameters_loc_6pe )

######################################################################
## state-related tests
######################################################################

ecbuild_add_test( TARGET test_aq_diffstates
                  MPI 6
                  OMP 4
                  ARGS testinput/diffstates.yaml
                  COMMAND  aq_diffstates.x )

ecbuild_add_test( TARGET test_aq_addincrement
                  MPI 6
                  OMP 4
                  ARGS testinput/addincrement.yaml
                  COMMAND  aq_addincrement.x
                  TEST_DEPENDS test_aq_diffstates )

ecbuild_add_test( TARGET test_aq_addincrement_scaled
                  MPI 6
                  OMP 4
                  ARGS testinput/addincrement_scaled.yaml
                  COMMAND  aq_addincrement.x
                  TEST_DEPENDS test_aq_diffstates )

######################################################################
## Tier 2 4d tests
######################################################################

if (AQ_JEDI_TEST_TIER GREATER_EQUAL 2)

    #####################################################################
    # B Matrix tests
    #####################################################################

    ecbuild_add_test( TARGET test_aq_parameters_loc_2pe
                      MPI 2
                      OMP 2
                      ARGS testinput/parameters_loc_2pe.yaml
                      COMMAND  aq_error_covariance_training.x )

    #####################################################################
    # dirac tests
    #####################################################################

    ecbuild_add_test( TARGET test_aq_dirac_no_loc_4d
                      MPI 12
                      OMP 2
                      ARGS testinput/dirac_no_loc_4d.yaml
                      COMMAND  aq_dirac.x )


    ecbuild_add_test( TARGET test_aq_dirac_loc_4d
                      MPI 12
                      OMP 2
                      ARGS testinput/dirac_loc_4d.yaml
                      COMMAND  aq_dirac.x
                      TEST_DEPENDS test_aq_parameters_loc_2pe )

    ######################################################################
    ## 4d variational tests
    ######################################################################

    ecbuild_add_test( TARGET test_aq_4densvar
                      MPI 12
                      OMP 2
                      ARGS testinput/4densvar.yaml
                      COMMAND  aq_var.x
                      TEST_DEPENDS test_aq_parameters_loc_2pe )

    ecbuild_add_test( TARGET test_aq_4densvar_transform
                      MPI 12
                      OMP 2
                      ARGS testinput/4densvar_transform.yaml
                      COMMAND  aq_var.x
                      TEST_DEPENDS test_aq_parameters_loc_2pe )

endif()
